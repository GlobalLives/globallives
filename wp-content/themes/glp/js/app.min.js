function onYouTubePlayerAPIReady(){YT_ready(!0)}function getFrameID(id){var elem=document.getElementById(id);if(elem){if(/^iframe$/i.test(elem.tagName))return id;var elems=elem.getElementsByTagName("iframe");if(!elems.length)return null;for(var i=0;i<elems.length&&!/^https?:\/\/(?:www\.)?youtube(?:-nocookie)?\.com(\/|$)/i.test(elems[i].src);i++);if(elem=elems[i],elem.id)return elem.id;do id+="-frame";while(document.getElementById(id));return elem.id=id,id}return null}function setup_players(){$(".participant-video-embed").each(function(){var identifier=this.id,frameID=getFrameID(identifier),clip_id=$("#participant-clip").data("clip-id"),next_clip_id=$("#participant-clip").data("next-clip-id");frameID&&(players[frameID]=new YT.Player(frameID,{events:{onStateChange:onStateChange(frameID,identifier),onReady:onReady(frameID,identifier)}}),$("#"+frameID).bind("player_ready",videoSetTimer),$("#"+frameID).bind("player_ready",setup_position_slider),$("#"+frameID).bind("player_ready",setup_volume_slider),$("body.tax-themes").length&&($("#"+frameID).bind("player_ready",mute_player),$("#"+frameID).hover(unmute_player,mute_player)),$("#"+frameID).bind("player_start_play_buffer",videoSetTimer),$("#"+frameID).bind("player_start_play_buffer",enable_taggable_area),$("#"+frameID).bind("player_start_play_buffer",display_taggable_area),$("#"+frameID).bind("player_start_play_buffer",toggle_play_pause_button),$("#"+frameID).bind("player_pause_end",toggle_play_pause_button),$("#"+frameID).bind("player_end",{clip_id:clip_id,next_clip_id:next_clip_id},play_next_video),$("#"+frameID).bind("player_time_update",videoUpdateTimer),$("#"+frameID).bind("player_time_update",videoUpdatePosition),$("#"+frameID).bind("player_time_update",autoShowComment))})}function onStateChange(frameID){return function(event){players[frameID];switch(event.data){case 1:case 3:$("#"+frameID).trigger("player_start_play_buffer"),t=setInterval(function(){playerTimeUpdate(frameID)},500);break;case 2:$("#"+frameID).trigger("player_pause_end"),clearTimeout(t);break;case 0:$("#"+frameID).trigger("player_pause_end"),$("#"+frameID).trigger("player_end"),clearTimeout(t)}}}function onReady(frameID){return function(){var player=players[frameID],isHtml5Player=!player.cueVideoByFlashvars;isHtml5Player&&!player.getDuration(),$("#"+frameID).trigger("player_ready")}}function playerTimeUpdate(frameID){$("#"+frameID).trigger("player_time_update")}function videoUpdatePosition(event){var player=players[event.currentTarget.id],slider=$("#"+event.currentTarget.id).siblings(".participant-video-controls").find(".control-slider");$(slider).slider("value",player.getCurrentTime()/player.getDuration()*1e3)}function autoShowComment(event){var slider=$("#"+event.currentTarget.id).siblings(".participant-video-controls").find(".control-slider"),position=parseInt($(slider).width()*((slider.slider("value")+1)/1e3),10),marker_box=$("#marker-"+position);marker_box.length&&$("#taggable-area").setupPopover().showPopover(position)}function videoUpdateTimer(event){var player=players[event.currentTarget.id],m=parseInt(player.getCurrentTime()/60,10)%60,s=parseInt(player.getCurrentTime()%60,10);10>s&&(s="0"+s),$(".control-time-current .time-m").text(m),$(".control-time-current .time-s").text(s)}function videoSetTimer(event){var player=players[event.currentTarget.id],m=parseInt(player.getDuration()/60,10)%60,s=parseInt(player.getDuration()%60,10);$(".control-time-total .time-m").text(m),$(".control-time-total .time-s").text(s)}function enable_taggable_area(){$("#taggable-area").click(function(e){if(!$("body").hasClass("logged-in"))return $(this).popover("hide"),alert("You must be logged in to comment."),!1;var xpos=parseInt(e.pageX-$(this).offset().left,10);$(this).setupPopover().showPopover(xpos)})}function setup_popover(){$("#taggable-area").setupPopover()}function add_comment_to_marker_box(position,comment_html){var marker_box=$("#marker-"+position);marker_box.length?$(marker_box).find(".content").prepend(comment_html):$(".clip-markers").append('<a class="marker" id="marker-'+position+'" style="left: '+position+'px"><div class="arrow"></div><div class="hide content">'+comment_html+"</div></div>")}function display_taggable_area(){$("#taggable-area").each(function(){$(this).show().find("span").each(function(){$(this).show().fadeTo(0,1).delay(1e3).fadeTo("slow",.3,function(){$(this).removeAttr("style")})})}),$(".clip-markers").show()}function toggle_play_pause_button(event){var player=players[event.currentTarget.id];switch(player.getPlayerState()){case 1:$(".play-pause").attr("data-control","pause").find("span").removeClass("icon-play").addClass("icon-pause");break;case 2:$(".play-pause").attr("data-control","play").find("span").removeClass("icon-pause").addClass("icon-play")}}function setup_position_slider(event){var slider=$("#"+event.currentTarget.id).siblings(".participant-video-controls").find(".control-slider").slider({range:"min",min:0,max:1e3});$(slider).on("slidestart",function(){var id=$(this).closest(".participant-clip").find(".participant-video-embed").attr("id");$("#"+id).unbind("player_time_update",videoUpdatePosition)}),$(slider).on("slidestop",function(event,ui){var id=$(this).closest(".participant-clip").find(".participant-video-embed").attr("id");players[id].seekTo(Math.round(players[id].getDuration()*(ui.value/1e3)*100)/100,!0),$("#"+id).bind("player_time_update",videoUpdatePosition)})}function setup_volume_slider(event){var player=players[event.currentTarget.id],slider=$("#"+event.currentTarget.id).siblings(".participant-video-controls").find(".volume-slider").slider({orientation:"vertical",range:"min",min:0,max:100,value:player.getVolume()});$(slider).on("slide",function(event,ui){player.setVolume(ui.value)})}function turn_out_the_lights(){$("#shadow").length?($("#shadow").fadeOut(500,function(){$(this).remove()}),$(".control-buttons-cntnr .dimmer").removeClass("active")):($("body").append('<div id="shadow" class="hide"></div>'),$("#shadow").fadeIn(500),$(".control-buttons-cntnr .dimmer").addClass("active"))}function toggle_comments(){$(".clip-markers").toggle(),$(".control-buttons-cntnr .comments").toggleClass("active")}function autoplay_video(event){players[event.currentTarget.id].playVideo()}function play_next_video(event){console.log("[LOADING] Current clip: "+event.data.clip_id+" Next: "+event.data.next_clip_id),event.data.next_clip_id&&$("#stage").slideUp().load(glpAjax.ajaxurl,{action:"get_participant_clip",clip_id:event.data.next_clip_id},function(){$("#stage").delay(250).slideDown(),$(window).trigger("setup_players")})}function mute_player(event){players[event.currentTarget.id].mute()}function unmute_player(event){players[event.currentTarget.id].unMute()}$(function(){function set_background(src,arg){var fade_from="rgba(0,0,0,0)",fade_to="rgba(0,0,0,0)",bg=new Image;arg&&(fade_from=arg.from?arg.from:fade_from,fade_to=arg.to?arg.to:fade_to),bg.src=src,bg.onload=function(){var gradient="("+fade_from+" 0, "+fade_to+" "+this.height+"px)",bg_url="url("+this.src+")";bg.src&&($("#wrap").css("background-image","-webkit-linear-gradient"+gradient+", "+bg_url),$("#wrap").css("background-image","-moz-linear-gradient"+gradient+", "+bg_url),$("#wrap").css("background-image","linear-gradient"+gradient+", "+bg_url))}}function set_stage(post_id){$("#stage").fadeOut("slow").load(glpAjax.ajaxurl,{action:"get_participant_summary",post_id:post_id},function(){$("#stage").fadeIn("slow"),$(window).trigger("setup_players"),reinit_addthis()})}function same_height(group){var resizeTimer;$(window).resize(function(){clearTimeout(resizeTimer),resizeTimer=setTimeout(function(){var tallest=0;$(group).height("auto"),$(group).each(function(){var thisHeight=$(this).height();thisHeight>tallest&&(tallest=thisHeight)}),$(group).height(tallest)},250)}),$(window).resize()}function reinit_addthis(){var addthis_url="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-510832576c1fd9d6";window.addthis&&(window.addthis=null,window._adr=null,window._atc=null,window._atd=null,window._ate=null,window._atr=null,window._atw=null),$.getScript(addthis_url)}function popModal(el){$(el).modal("show")}function toggle_view(view){$(".view").slideUp(500,function(){$(view).delay(700).slideDown(500),$(".btn-"+view.substring(1)).addClass("active").siblings().removeClass("active")}),window.location.hash=view}function filterParticipants(){$(participants).each(function(){this.filtered===!0||this.filteredByTheme===!0?($("#participant-"+this.id).addClass("filtered"),d3.selectAll("#marker-"+this.id).classed("filtered",!0)):($("#marker-"+this.id+", #participant-"+this.id).removeClass("filtered"),d3.selectAll("#marker-"+this.id).classed("filtered",!1))})}function showConnections(hub_id){var hub_marker=map.select("#marker-"+hub_id),hub_xy=[+hub_marker.attr("data-x"),+hub_marker.attr("data-y")],hub_participant=$.grep(participants,function(p){return p.id==hub_id})[0];$(participants).each(function(){var shared_themes=shared(hub_participant.themes,this.themes);if(this.id!==hub_id&&shared_themes.length>0){var spoke_id=this.id,spoke_marker=map.select("#marker-"+spoke_id),spoke_xy=[+spoke_marker.attr("data-x"),+spoke_marker.attr("data-y")];underlay.append("path").attr("class","edge").attr("id","edge-"+spoke_id).attr("d",function(){return hub_xy[0]<spoke_xy[0]?"M"+hub_xy[0]+","+hub_xy[1]+"L"+spoke_xy[0]+","+spoke_xy[1]+"Z":"M"+spoke_xy[0]+","+spoke_xy[1]+"L"+hub_xy[0]+","+hub_xy[1]+"Z"}).style("stroke","#fff").style("stroke-width",3).style("opacity",.25),underlay.append("text").attr("class","edge-label").style("fill","#fff").style("text-anchor","middle").attr("dy",3).append("textPath").attr("xlink:href","#edge-"+spoke_id).attr("startOffset","25%").text(shared_themes)}})}function clearConnections(){map.selectAll(".edge, .edge-label").remove()}function shared(a,b){return a.length>0&&b.length>0?$.grep(a,function(i){return""!=a?$.inArray(i,b)>-1:!1}):!1}if($("a:has(img)").addClass("image-link"),same_height("#nav-modules .widget"),$("input.copyable").click(function(){$(this).select()}),$("#signup-tab").click(function(ev){ev.preventDefault(),popModal("#signup-modal")}),$("#login-tab").click(function(ev){ev.preventDefault(),popModal("#login-modal")}),$("body.page-home").length&&($(".carousel").carousel("pause"),$("#featured-carousel").bind("slide",function(){$("#featured-carousel").css("overflow","hidden")}),$("#featured-carousel").bind("slid",function(){$("#featured-carousel").css("overflow","visible")}),$("#nav-featured .participant-thumbnail").popover(),$("#nav-featured .participant-thumbnail").click(function(){$(".home-thumbnail, .participant-thumbnail").removeClass("active"),$(this).addClass("active"),$("#home").fadeOut("slow"),set_stage($(this).data("id"))}),$("#nav-featured .home-thumbnail").click(function(){$("#stage").fadeOut("slow",function(){$(".participant-thumbnail").removeClass("active"),$(".home-thumbnail").addClass("active"),$("#home").fadeIn("slow")})})),$("body.page-explore").length){var view=window.location.hash;("#mapview"===view||"#gridview"===view)&&toggle_view(view),$(".btn-mapview").click(function(){toggle_view("#mapview")}),$(".btn-gridview").click(function(){toggle_view("#gridview")}),$("#nav-explore input, #nav-explore select").change(function(){return $(participants).each(function(){this.filtered=!1,$("select[name=series]").val()&&"All"!==$("select[name=series]").val()&&-1===$.inArray($("select[name=series]").val(),this.series)&&(this.filtered=!0),"All"!==$("select[name=gender]").val()&&this.gender!==$("select[name=gender]").val()&&(this.filtered=!0),"All"!==$("select[name=income]").val()&&this.income!==$("select[name=income]").val()&&(this.filtered=!0),"All"!==$("select[name=age]").val()&&this.age!==$("select[name=age]").val()&&(this.filtered=!0)}),$("input[name=proposed]:checked").val()?($(".proposed").removeClass("hide"),d3.selectAll(".marker.proposed").style("opacity",1)):($(".proposed").addClass("hide"),d3.selectAll(".marker.proposed").style("opacity",0)),filterParticipants(),!1})}if($("#nav-themes").length&&($("#nav-themes li").hover(function(){$(this).siblings().children(".flyup").slideUp(),$(this).children(".flyup").slideDown()},function(){$(this).children(".flyup").slideUp()}),$("#nav-themes li").click(function(){var theme=$(this).attr("data-term");$(participants).each(function(){this.filteredByTheme=!1,theme&&-1==$.inArray(theme,this.themes)&&(this.filteredByTheme=!0)}),filterParticipants(),$(this).addClass("active").siblings().removeClass("active")}),$("#nav-themes .flyup .thumbnails").cycle()),$("#mapview").length){var single_participant_id=$("article.participant").attr("data-participant_id");window.location.hash&&"mapview"===window.location.hash||$("#mapview").hide(),$("#mapview").css("max-height",function(){return $(window).height()-$("#content").offset().top-$("#nav-explore").height()-$("#nav-themes").height()-$(".handle").height()});var height=$("#mapview").height(),width=Math.min($("#mapview").width(),$(".container").width()),projection=d3.geo.mercator().scale(.16*width).translate([width/2,height/1.75]),path=d3.geo.path().projection(projection),map=(d3.behavior.zoom().translate(projection.translate()).scale(projection.scale()).scaleExtent([.15*width,8*height]).on("zoom",function(){projection.translate(d3.event.translate).scale(d3.event.scale),countries.selectAll("path").attr("d",path),map.selectAll(".marker").attr("transform",function(d){return"translate("+projection([+d.longitude,+d.latitude])+")"})}),d3.select("#mapview").append("svg").attr("height",height).attr("width",width)),countries=map.append("g").attr("id","countries");countries.append("rect").attr("class","background").attr("height",height).attr("width",width);var underlay=map.append("g").attr("id","underlay"),marker=(map.append("defs").selectAll("thumbnails").data(participants).enter().append("pattern").attr("id",function(d,i){return"image-"+i}).attr("patternUnits","objectBoundingBox").attr("width",50).attr("height",50).append("image").attr("xlink:href",function(d){return d.thumbnail}).attr("x",0).attr("y",0).attr("width",function(d){return single_participant_id==d.id?64:48}).attr("height",function(d){return single_participant_id==d.id?64:48}),map.selectAll(".marker").data(participants).enter().append("g").attr("id",function(d){return"marker-"+d.id}).attr("class",function(d){return"marker "+d.continent+(d.proposed?" proposed":"")}).attr("transform",function(d){return"translate("+projection([+d.longitude,+d.latitude])+")"}).attr("data-x",function(d){var coords=projection([+d.longitude,+d.latitude]);return Math.round(coords[0])}).attr("data-y",function(d){var coords=projection([+d.longitude,+d.latitude]);return Math.round(coords[1])}).on("click",function(d){window.location=d.permalink}));marker.append("circle").attr("class","pin").attr("r",5),marker.append("circle").attr("class",function(d){return single_participant_id==d.id?"mapthumb single":"mapthumb"}).attr("id",function(d,i){return"mapthumb-"+i}).attr("r",function(d){return single_participant_id==d.id?32:24}).attr("fill",function(d,i){return"url(#image-"+i+")"});var label=marker.append("text").attr("class","label").attr("dx",-25).attr("dy",function(d){return single_participant_id==d.id?48:40});label.append("tspan").attr("class","name").text(function(d){return d.name}),label.append("tspan").attr("class","occupation").text(function(d){return d.occupation}).attr("x",-25).attr("dy",15),label.append("tspan").attr("class","location").text(function(d){return d.location}).attr("x",-25).attr("dy",15),d3.json("/wp-content/themes/glp/js/vendor/countries.json",function(json){countries.selectAll("path").data(json.features).enter().append("svg:path").attr("d",path)}),d3.json("/wp-content/themes/glp/js/vendor/countries-hires.json",function(json){countries.selectAll("path").remove(),countries.selectAll("path").data(json.features).enter().append("svg:path").attr("d",path)}),$(".overlay, .mapthumb:not(.single), .label, #popover").hide(),(hub_id=$("article.participant").attr("data-participant_id"))?(showConnections(hub_id),$(".marker").hover(function(){$(this).find(".mapthumb, .label").show()},function(){$(this).find(".mapthumb:not(.single), .label").hide()})):$(".marker").hover(function(){$(this).find(".mapthumb, .label").show(),showConnections($(this).attr("id").split("-")[1])},function(){$(this).find(".mapthumb:not(.single), .label").hide(),clearConnections()}),$(".background, #popover .close").click(function(){$("#popover, .overlay").hide(),clearConnections()}),$(".background").click(function(){$(".mapthumb:not(.single), .label").hide()})}if($(".blog").length){var bg=$(".blog .post").first().data("bg");bg&&set_background(bg,{to:"#262626"}),$(".past-posts .post").each(function(){var bg=$(this).data("bg");bg&&$(this).css("background-image","url("+bg+")")})}if($(".events-list").length&&$(".tribe-events-event").each(function(){var bg=$(this).data("bg");bg&&$(this).css("background-image","url("+bg+")")}),$(".search-sidebar :checkbox").change(function(){var post_type=$(this).val();$(".search-result."+post_type).slideToggle("",function(){$(".results-found").html($(".search-result:visible").length)})}),$("body.tax-series").length&&($(".carousel").carousel("pause"),$("#series-carousel").bind("slide",function(){$("#series-carousel").css("overflow","hidden")}),$("#series-carousel").bind("slid",function(){$("#series-carousel").css("overflow","visible")}),$("#nav-series .participant-thumbnail").click(function(){$("#home").fadeOut("slow"),set_stage($(this).data("id"))}),$("#nav-series .home-thumbnail").click(function(){$("#stage").fadeOut("slow",function(){$("#home").fadeIn("slow")})}),$(".btn-mapview").click(function(){$("#mapview").slideToggle(500)})),$("body.tax-themes").length&&$("#theme-select").change(function(){window.location="/themes/"+$(this).val()}),$("body.single-participant").length){console.log("good so far.");var single_participant_id=$("article.participant").attr("data-participant_id");$("#nav-themes").hide(),$(".participant-detail-map .handle").click(function(){console.log("handle"),$("#mapview, #nav-themes").slideToggle(),$(".participant-detail-map .handle .btn span").toggle()}),$(".participant-filter-clips a.filter").click(function(){$(this).toggleClass("active"),$(".participant-clip-listing."+$(this).data("tag")).toggle()})}if($("#donate-banner").length){var banner=$("#donate-banner");banner.delay(1e3).slideDown(2e3),$(".not-now").click(function(){banner.slideUp(2e3)})}}),$(function(){$(window).bind("setup_players",setup_players),$(window).bind("setup_players",setup_popover),$(".controls").live("click",function(){var id=$(this).closest(".participant-clip").find(".participant-video-embed").attr("id"),control=(players[id],$(this).attr("data-control"));switch(control){case"play":players[id].playVideo();break;case"pause":players[id].pauseVideo();break;case"fullscreen":var el=document.getElementById(id);el.requestFullScreen?el.requestFullScreen():el.mozRequestFullScreen?el.mozRequestFullScreen():el.webkitRequestFullScreen&&el.webkitRequestFullScreen();break;case"comments":toggle_comments();break;case"dimmer":turn_out_the_lights()}}),$(document).on("click",".popover .close",function(){$(this).closest(".popover").prev().popover("hide")}),$(document).on("submit",".popover form",function(){return $(this).find(".error").fadeOut("slow",function(){$(this).remove()}),$.post(glpAjax.ajaxurl,{action:"clip_submit_comment",comment:$(this).find('input[name="comment"]').val(),minutes:$("#taggable-area").data("m"),seconds:$("#taggable-area").data("s"),position:$("#taggable-area").data("p"),post_id:$(".participant-video-embed").attr("id").replace("participant-video-embed-","")},function(response){r=$.parseJSON(response),$(".comment-box").prepend(r.message).closest("form").find("input").val(""),r.success&&add_comment_to_marker_box(r.success,r.message),$(".popover").fixPopoverHeight()}),!1}),$(document).on("click","#shadow",function(){turn_out_the_lights()}),$(document).on("mouseenter",".marker",function(){var xpos=parseInt($(this).attr("id").replace("marker-",""),10);$("#taggable-area").setupPopover().showPopover(xpos)}),$(document).on("mouseleave",".marker",function(){}),$(document).on("click",".participant-clip-listing .clip-thumbnail",function(){$("html, body").scrollTop(0);var clip_id=$(this).data("clip-id");$(this).parents(".participant-clip-listing").addClass("active").siblings().removeClass("active"),$("#stage").slideUp().load(glpAjax.ajaxurl,{action:"get_participant_clip",clip_id:clip_id},function(){$("#stage").delay(250).slideDown(),$(window).trigger("setup_players")})}),$(document).on("click",".btn-toggle",function(){var user_id=$(this).data("user-id"),clip_id=$(this).data("clip-id"),toggle_type=$(this).data("toggle-type");return $(this).load(glpAjax.ajaxurl,{action:"toggle_clip",user_id:user_id,clip_id:clip_id,toggle_type:toggle_type},function(response){$("[data-clip-id='"+clip_id+"'][data-toggle-type='"+toggle_type+"']").html(response)}),!1}),$(document).on("click",".btn-toggle-all",function(){var user_id=$(this).data("user-id"),post_id=$(this).data("list-id");return $.post(glpAjax.ajaxurl,{action:"toggle_clip_list",user_id:user_id,post_id:post_id},function(data){response=$.parseJSON(data),$("[data-list-id='"+post_id+"'][data-user-id='"+user_id+"']").html(response.text);for(var i in response.toggled)clip_id=response.toggled[i],$.post(glpAjax.ajaxurl,{action:"clip_status",user_id:user_id,clip_id:clip_id},function(status){status=$.parseJSON(status),$("[data-clip-id='"+status.clip_id+"'][data-toggle-type='queue']").html(status.status)})}),!1}),$(document).on("click",".btn-play-all",function(){$.each(players,function(){this.playVideo()})})});var players={},t;!function(){var s=document.createElement("script");s.src=("https:"==location.protocol?"https":"http")+"://www.youtube.com/player_api";var before=document.getElementsByTagName("script")[0];before.parentNode.insertBefore(s,before)}();var YT_ready=function(){var onReady_funcs=[],api_isReady=!1;return function(func,b_before){if(func===!0)for(api_isReady=!0;onReady_funcs.length;)onReady_funcs.shift()();else"function"==typeof func&&(api_isReady?func():onReady_funcs[b_before?"unshift":"push"](func))}}();YT_ready(function(){$(window).trigger("setup_players")}),$.fn.setupPopover=function(){var content=this.next().find(".content").html(),title=this.next().find(".title").html();return this.popover({html:!0,animation:!1,content:content,title:title}),this},$.fn.showPopover=function(xpos){var id=this.closest(".participant-clip").find(".participant-video-embed").attr("id"),player=players[id],percent=xpos/this.width(),spos=Math.round(player.getDuration()*percent*100)/100,m=parseInt(spos/60,10)%60,s=parseInt(spos%60,10);this.data("m",m).data("s",s).data("p",xpos),this.popover("show");var popover_box=this.next(),offset=xpos-popover_box.width()/2;return $(popover_box).find(".comment-box").prepend($("#marker-"+xpos+" .content").html()),$(popover_box).css("left",offset).find(".time").text(m+":"+s),$(popover_box).fixPopoverHeight(),this},$.fn.fixPopoverHeight=function(){return this.css("top",0-this.height()-20),this};